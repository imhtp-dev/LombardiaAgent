name: Deploy Optimized Docker to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VM with Docker
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 600s
        command_timeout: 600s
        script: |
          echo "ğŸš€ Starting optimized Docker deployment..."

          # Navigate to project directory
          cd /home/${{ secrets.VM_USERNAME }}/voilavoicebooking

          # Pull latest changes from GitHub with proper authentication
          echo "ğŸ“¥ Pulling latest changes..."
          git config --global --add safe.directory /home/${{ secrets.VM_USERNAME }}/voilavoicebooking
          git remote set-url origin https://github.com/imhtp-dev/voilavoicebooking.git
          git config --global credential.helper store
          echo "https://mohammad-mussab:${{ secrets.TOKEN }}@github.com" > ~/.git-credentials
          git fetch origin
          git reset --hard origin/main

          # Stop and remove existing containers
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose down || docker stop $(docker ps -q) || echo "No containers to stop"

          # Remove old images to save space
          echo "ğŸ§¹ Cleaning up old Docker images..."
          docker image prune -f
          docker system prune -f

          # Build and start optimized container
          echo "ğŸ”§ Building optimized container..."
          docker-compose up -d --build

          # Wait for container to be ready
          echo "â³ Waiting for container to start..."
          sleep 15

          # Check if container is running
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… Container started successfully!"
            echo "ğŸ“Š Container status:"
            docker-compose ps
            echo "ğŸ¥ Health check:"
            curl -f http://localhost:8000/health || echo "Health check pending..."
          else
            echo "âŒ Container failed to start"
            echo "ğŸ“‹ Container logs:"
            docker-compose logs --tail=20
            exit 1
          fi

          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Agent ready for 9-10 concurrent calls"

    - name: Verify deployment health
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ” Final verification..."

          # Wait a bit more for full startup
          sleep 10

          # Check container health
          if curl -f http://localhost:8000/health; then
            echo "âœ… Health check passed - Agent is ready!"
            echo "ğŸ“Š Resource usage:"
            docker stats --no-stream
          else
            echo "âš ï¸ Health check failed - checking logs"
            docker-compose logs --tail=10
          fi