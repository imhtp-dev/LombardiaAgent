name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment to Azure VM..."

          # Navigate to project directory
          cd /home/${{ secrets.VM_USERNAME }}/voilavoicebooking

          # Stop the current agent process
          echo "ğŸ›‘ Stopping current agent..."
          pkill -f "python.*bot.py" || echo "No running bot process found"
          pkill -f "uvicorn.*bot:app" || echo "No running uvicorn process found"

          # Pull latest changes from GitHub
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main

          # Install/update dependencies if requirements changed
          echo "ğŸ“¦ Checking dependencies..."
          pip install -r requirements.txt --upgrade

          # Wait a moment for processes to fully stop
          sleep 3

          # Start the agent in background with nohup
          echo "ğŸš€ Starting agent..."
          cd /home/${{ secrets.VM_USERNAME }}/voilavoicebooking
          nohup python bot.py > logs/bot.log 2>&1 &

          # Wait a moment and check if process started
          sleep 5
          if pgrep -f "python.*bot.py"; then
            echo "âœ… Agent started successfully!"
            echo "ğŸ“Š Process details:"
            ps aux | grep "python.*bot.py" | grep -v grep
          else
            echo "âŒ Failed to start agent"
            echo "ğŸ“‹ Last few log lines:"
            tail -10 logs/bot.log || echo "No log file found"
            exit 1
          fi

          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Agent should be available at your VM IP on port 8000"

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ” Verifying deployment..."

          # Check if agent is running
          if pgrep -f "python.*bot.py"; then
            echo "âœ… Agent process is running"

            # Test health endpoint (wait for startup)
            sleep 10
            if curl -f http://localhost:8000/health; then
              echo "âœ… Health check passed"
            else
              echo "âš ï¸ Health check failed - agent might still be starting"
            fi
          else
            echo "âŒ Agent process not found"
            exit 1
          fi